# Extract features from Spectra
```{r extractFeatures, cache = TRUE}
createFeatureTbl <- function(trainList, mzTol, testSet = F) {
    idx <- if(testSet) -trainList$idx else trainList$idx
    suffix <- if(testSet) "_test" else "_train"
    suffix2 <- if(str_detect(trainList$regex, "Acineto")) "_Ab" else "_Kp"
    
    # Preprocess spectra
    spec <- preProcessSpec(files[idx], hws = 80)
    multiSpecIdx <- map_lgl(spec, ~ metaData(.)$num > 1)
    spec <- spec[!multiSpecIdx]
    
    # extract spectra 
    spectbl <- map_df(spec, extractSpectra) %>% 
      mutate(type = as.factor(type), id = as.factor(id))
    
    # extract specified features
    feattbl <- spectbl %>%
      group_by(id) %>%
      do(extractFeatures(., featureVec = trainList$features, tol = mzTol))
    
    saveRDS(feattbl, file = paste0("../temp/featureInfo", suffix2, suffix))
    
    mlFeat <- feattbl %>%
      select(id, type, feat, relInt) %>%
      group_by(id) %>%
      mutate(relInt = relInt / max(relInt)) %>%
      ungroup() %>%
      spread(key = feat, value = relInt, fill = 0) %>%
      mutate(Ab = ifelse(str_detect(type, "i - r"), "pos", "other"),
             Kp = ifelse(str_detect(type, "e - r"), "pos", "other"),
             Ab = as.factor(ifelse(str_detect(type, "i - s"), "neg", Ab)),
             Kp = as.factor(ifelse(str_detect(type, "e - s"), "neg", Kp)))
    
    return(mlFeat)
}

trainDatList <- map(trainIdx, createFeatureTbl, 
                    mzTol = 1,
                    testSet = F)

```