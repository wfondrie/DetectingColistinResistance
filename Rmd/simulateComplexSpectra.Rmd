---
title: "Simulating Glycolipid MALDI-TOF-MS of Complex Samples"
Author: "William E Fondrie"
Date: "7/20/17"
output: github_document
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Load Libraries

```{r loadLibraries}
library(plyr, quietly = T)
library(tidyverse, quietly = T)
library(MALDIquant, quietly = T)
library(MALDIquantForeign, quietly = T)
library(stringr, quietly = T)
library(doParallel, quietly = T)
library(forcats, quietly = T)

source("../R/preProcessSpec.R")
source("../R/extract.R")
source("../R/ggplotTheme.R")

set.seed(6578548)  
```

# Get file info

```{r importSpectra}
files <- list.files("../data/fullLib", 
                    full.names = T, 
                    pattern = "mzXML$",
                    recursive = T)
#files <- sample(files, 100)

specInfo <- tibble(fname = files) %>%
    mutate(type = str_match(fname, "([^\\^/]+)[\\/][^\\^/]+mzXML$")[ , 2],
           id = str_match(fname, "([^\\^/]+).mzXML$")[ , 2],
           species = str_match(type, "^[^ ]+ [^ ]+")[ , 1],
           Ab = ifelse(str_detect(type, "Acinetobacter baumannii - res"), "pos", "other"),
           Kp = ifelse(str_detect(type, "Klebsiella pneumoniae - res"), "pos", "other"),
           Ab = as.factor(ifelse(str_detect(type, "Acinetobacter baumannii - sen"), "neg", Ab)),
           Kp = as.factor(ifelse(str_detect(type, "Klebsiella pneumoniae - sen"), "neg", Kp)))

summary(specInfo)

```

# Select Linear Combinations

```{r combinations}
selectLinearCombos <- function(n, info) {
  
  speciesSelect <- info %>%
    group_by(species) %>%
    summarize(num = length(id)) %>%
    sample_n(size = n)
  
  selected <- speciesSelect %>%
    left_join(info) %>%
    group_by(species) %>%
    sample_n(size = 1) %>%
    ungroup() %>%
    mutate(coeff = runif(n, 0.1, 1))
  
  return(selected)
}

numSpecies <- rep(c(1:5), 2000)


combos <- tibble(spec_id = as.factor(paste0("spec_", 1:length(numSpecies))),
                 comp = map(numSpecies, selectLinearCombos, info = specInfo)) %>%
  unnest()

comboSummary <- combos %>%
  group_by(spec_id) %>%
  summarize(n = length(id),
            AbCoeff = ifelse(any(Ab != "other"), coeff[Ab != "other"] / max(coeff), 0),
            KpCoeff = ifelse(any(Kp != "other"), coeff[Kp != "other"] / max(coeff), 0),
            AbPres = ifelse(any(Ab == "pos"), "pos", "other"),
            KpPres = ifelse(any(Kp == "pos"), "pos", "other"),
            AbPres = as.factor(ifelse(any(Ab == "neg"), "neg", AbPres)),
            KpPres = as.factor(ifelse(any(Kp == "neg"), "neg", KpPres)))

summary(comboSummary)

saveRDS(comboSummary, file = "../temp/complexSpectraSummary.rds")
saveRDS(combos, file = "../temp/complexComponents.rds")
```

# Create Complex Spectra from Selections And Extract Features

```{r createSpectra}
# list of features, created in rmd/modelTraining.rmd
features <- readRDS("../temp/features.rds")

specList <- preProcessSpec(files, hws = 80) # Same preprocessing

# rm files that contain multiple spectra
multiSpecIdx <- map_lgl(specList, ~ metaData(.)$num > 1)
specList <- specList[!multiSpecIdx]

spec <- map_df(specList, extractSpectra)

# Main function to simulate complex spectra
# - specInfo should contain the file names and coefficients for the constituents of each spectrum
makeComplexSpec <- function(specInfo, specDf) {
    specInfo <- specInfo %>%
        left_join(specDf) %>%
        group_by(spec_id, id, type) %>%
        do(massSpecObj = createMassSpectrum(mass = .$mz, intensity = .$relInt, 
                                            metaData = 
                                                list(file = paste0("/cmb/", .$spec_id[1], ".mzXML")))) %>%
        group_by(spec_id) %>%
        do(massSpecObj = averageMassSpectra(.$massSpecObj, method = "sum"))
    
    newSpec <- extractSpectra(specInfo$massSpecObj[[1]])
    return(newSpec)
}

# helper function to loop over makeComplexSpec for each spectrum
f <- function(x, s) {
    x %>%
    left_join(s) %>%
    do(makeComplexSpec(.))
}

# cl <- makeCluster(8)       # For parallelization
# registerDoParallel(cl)

# makes the complex spectra... and takes a ton of memory
# tictoc::tic()
# comboSpec <- ddply(combos, "spec_id", f, spec,
#                    .parallel = T,
#                    .paropts = list(
#                      .packages = c("dplyr", "MALDIquant", "stringr"),
#                      .export = c("makeComplexSpec", "extractSpectra")))
# t1 <- tictoc::toc()
# t1 <- t1$toc - t1$tic

t2 <- tictoc::tic()
comboSpec2 <- combos %>% 
    group_by(spec_id) %>%
    do(makeComplexSpec(., spec))
t2 <- tictoc::toc()
t2 <- t2$toc - t2$tic

saveRDS(comboSpec, "../temp/comboSpec.rds")

stopCluster(cl)

# extract features for prediction
feattbl <- comboSpec %>%
  group_by(id) %>%
  do(extractFeatures(., featureVec = unique(features$mz), tol = 1.5))

saveRDS(feattbl, "../temp/comboFeatTbl.rds")

mlFeat <- feattbl %>%
  select(id, feat, relInt) %>%
  group_by(id) %>%
  mutate(relInt = relInt / max(relInt)) %>%
  ungroup() %>%
  spread(key = feat, value = relInt, fill = 0) %>%
  left_join(comboSummary, by = c("id" = "spec_id")) 

saveRDS(mlFeat, file = "../temp/complexFeatures.rds")
```






